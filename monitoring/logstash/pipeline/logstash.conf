input {
  # Receive logs from Docker containers
  tcp {
    port => 5000
    codec => json
  }

  # Receive logs from syslog
  syslog {
    port => 5140
    codec => plain
  }

  # Receive logs from file
  file {
    path => "/var/log/school-timetable/*.log"
    start_position => "beginning"
    codec => multiline {
      pattern => "^\["
      negate => true
      what => "previous"
    }
  }
}

filter {
  # Parse JSON logs
  if [type] == "json" {
    json {
      source => "message"
    }
  }

  # Extract timestamp
  date {
    match => [ "timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss" ]
    target => "@timestamp"
  }

  # Add log level tags
  if [level] == "ERROR" or [level] == "error" {
    mutate {
      add_tag => [ "error" ]
    }
  }

  if [level] == "WARN" or [level] == "warn" {
    mutate {
      add_tag => [ "warning" ]
    }
  }

  # Extract HTTP request information
  if [type] == "http" {
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
    }
    
    mutate {
      convert => { "bytes" => "integer" }
      convert => { "response" => "integer" }
      convert => { "duration" => "float" }
    }
  }

  # Extract database query information
  if [type] == "database" {
    grok {
      match => { "message" => "Query_time: %{NUMBER:query_time:float}.*Lock_time: %{NUMBER:lock_time:float}.*Rows_sent: %{NUMBER:rows_sent:integer}.*Rows_examined: %{NUMBER:rows_examined:integer}" }
    }
  }

  # Remove sensitive data
  mutate {
    remove_field => ["password", "token", "api_key", "secret"]
  }

  # Add environment and host information
  mutate {
    add_field => {
      "environment" => "${ENV_ENV:production}"
      "service" => "school-timetable"
    }
  }

  # GeoIP lookup for client IP
  if [clientip] {
    geoip {
      source => "clientip"
      target => "geoip"
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "logs-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }

  # Send errors to a separate index
  if "error" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "errors-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }

  # Console output for debugging
  if [@metadata][debug] {
    stdout {
      codec => rubydebug
    }
  }
}
